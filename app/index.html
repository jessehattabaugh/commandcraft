<!DOCTYPE html>
<html>
<head>
  <title>CommandCraft</title>
  <style type="text/css">
    section:not(:last-child) {
      border-bottom: 1px solid gray;
      margin-bottom: 1em;
    }

    input[type=number]{
      width: 3em;
    }
  </style>
</head>
<body>

  <form id="app">
  
    <section>
      <label>Command
        <select data-bind="
          options: commands,
          optionsText: 'id',
          value: selected.command
        "></select>
      </label>
    </section>
    
    <section data-bind="visible: selected.command().id == 'give'">
      
      <section>
        <label>Player
          <input data-bind="
            value: selected.playerName,
            event: {keydown: function () {
              selected.playerVar('');
              return true;
            }}
          ">
          <select data-bind="
            options: variables,
            optionsText: 'name',
            value: selected.playerVar,
            optionsCaption: '-',
            event: {change: function () {
              selected.playerName('');
            }}
            "></select>
        </label>
      </section>
      
      <section>
        <label>Item
          <select data-bind="
            options: items,
            optionsText: 'name',
            value: selected.item
          "></select>
        </label>
      </section>
      
      <section>
        <label>Amount
          <input type="number" min="1" max="64" data-bind="value: selected.amount">
        </label>
      </section>
      
      <section>
        <label>Metadata
          <input type="number" min="0" max="256" data-bind="value: selected.metadata">
        </label>
      </section>
      
      <section data-bind="template: 'tagTemplate'"></section>
      
    </section>
    
    <!-- Summon Options ------------------------------------------------------->
    <section data-bind="visible: selected.command().id  == 'summon'">
      
      <section>
        <label>Entity
          <select data-bind="
            options: entities,
            optionsText: 'name',
            value: selected.entity
          "></select>
        </label>
      </section>
      
      <section>
        <fieldset>
          <legend>Coordinates</legend>
          
          <div>
            <label>X
              <input type="number" data-bind="value: selected.x">
            </label>
            <label>
              <input type="checkbox" data-bind="checked: selected.xRelative"> relative
            </label>
          </div>
          
          <div>
            <label>Y
              <input type="number" min="0" max="256" data-bind="value: selected.y">
            </label>
            <label>
              <input type="checkbox" data-bind="checked: selected.yRelative"> relative
            </label>
          </div>
          
          <div>
            <label>Z
              <input type="number" data-bind="value: selected.z">
            </label>
            <label>
              <input type="checkbox" data-bind="checked: selected.zRelative"> relative
            </label>
          </div>
          
        </fieldset>
        
      </section>
      
      <section data-bind="template: 'tagTemplate'"></section>
      
    </section>
    
    <!-- Output --------------------------------------------------------------->
    <section>
      <label>Output
        <textarea style="width: 100%; height: 10em" data-bind="text: output"></textarea>
      </label>
    </section>
    
  </form>
  
  <script type="text/html" id="tagTemplate">
    <label>Tags
      <select data-bind="
        options: tags, 
        optionsText: 'id',
        value: selected.tag
      "></select>
      <input type="button" value="Add" data-bind="click: addTag">
    </label>
    
    <ul data-bind="foreach: selected.tags">
      <li>
        <label data-bind="attr: {title: tag.description}">
          <span data-bind="text:tag.id"></span>
          <input data-bind="value: value">
        </label>
      </li>
    </ul>
  </script>

  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.0.0/knockout-min.js"></script>
  <script type="text/javascript">

    function App() {
      var self = this;
      
      self.commands = ko.observable({id: "Loading..."});
      self.variables = ko.observable();
      self.entities = ko.observable();
      self.items = ko.observable({id: "Loading..."});
      self.tags = ko.observable();
      
      // load data via ajax
      $.get('commands', {}, function success(res) { self.commands(res); });
      $.get('variables', {}, function success(res) { self.variables(res); });
      $.get('entities', {}, function success(res) { self.entities(res); });
      $.get('items?disabled__ne=true', {}, function success(res) { self.items(res); });
      $.get('tags', {}, function success(res) { self.tags(res); });
      
      // the command we are currently building
      self.selected = {
        command: ko.observable(''),
        playerVar: ko.observable({id: "Loading..."}),
        playerName: ko.observable(''),
        entity: ko.observable(''),
        item: ko.observable(0),
        amount: ko.observable(1),
        metadata: ko.observable(0),
        x: ko.observable('0'),
        xRelative: ko.observable(true),
        y: ko.observable('0'),
        yRelative: ko.observable(true),
        z: ko.observable('0'),
        zRelative: ko.observable(true),
        tag: ko.observable({}),
        tags: ko.observableArray([])
      };
      
      self.selected.player = ko.computed(function choosePlayer() {
        var playerVar = self.selected.playerVar(),
          playerName = self.selected.playerName();
        if(playerVar) return playerVar.id;
        else return playerName
      });
      
      self.tagString = ko.computed(function stringify() {
        //console.log("constructing tag string");
        var out = [], 
          tags = self.selected.tags(), 
          count = tags.length;
        for(var i = 0; i < count; i++) {
          out.push(tags[i].tag.id + ":" + tags[i].value());
        }
        return "{" + out.join(",") + "}";
      });
      
      self.output = ko.computed(function compile() {
        var args = [self.selected.command().id];
        
        switch (args[0]) {
            
          case 'give':
            args = args.concat([
              self.selected.player(),
              self.selected.item().id,
              self.selected.amount(),
              self.selected.metadata(),
              self.tagString()
            ]);
            break;
            
          case 'summon':
            args = args.concat([
              self.selected.entity().name,
              (self.selected.xRelative() ? '~' : '') + self.selected.x(),
              (self.selected.yRelative() ? '~' : '') + self.selected.y(),
              (self.selected.zRelative() ? '~' : '') + self.selected.z(),
              self.tagString()
            ]);
            break;
        }
        
        return "/" + args.join(" ");
      });
      
      self.addTag = function (tag) {
        self.selected.tags.push({
          tag: self.selected.tag(),
          value: ko.observable()
        });
      };
    }
    var app = new App();
    ko.applyBindings(app, $('app')[0]);

  </script>
</body>
</html>