<!DOCTYPE html>
<html>
<head>
  <title>CommandCraft</title>
  <style type="text/css">
    section:not(:last-child) {
      border-bottom: 1px solid gray;
      margin-bottom: 1em;
    }
    input[type=number]{
      width: 3em;
    }
  </style>
</head>
<body>
    
  <!-- Command picker --------------------------------------------------------->
  <section>
    <label>Command
      <select data-bind="
        options: commands,
        optionsText: 'id',
        value: command
      "></select>
    </label>
  </section>
  
  <!-- Entity Picker ---------------------------------------------------------->
  <!-- ko if: command().id === 'summon' -->
    <section>
      <label>Entity
        <select data-bind="
          options: entities,
          optionsText: 'name',
          value: entity
        "></select>
      </label>
    </section>
  <!-- /ko -->
  
  <!-- Coordinate Picker ------------------------------------------------------>
  <!-- ko if: command().id === 'summon' -->
    <section>
      <fieldset>
        <legend>Coordinates</legend>
        
        <div>
          <label>X
            <input type="number" data-bind="value: x">
          </label>
          <label>
            <input type="checkbox" data-bind="checked: x.rel"> relative
          </label>
        </div>
        
        <div>
          <label>Y
            <input type="number" min="0" max="256" data-bind="value: y">
          </label>
          <label>
            <input type="checkbox" data-bind="checked: y.rel"> relative
          </label>
        </div>
        
        <div>
          <label>Z
            <input type="number" data-bind="value: z">
          </label>
          <label>
            <input type="checkbox" data-bind="checked: z.rel"> relative
          </label>
        </div>
        
      </fieldset>
    </section>
  <!-- /ko -->
  
  <!-- Player picker ---------------------------------------------------------->
  <!-- ko if: command().id === 'give' -->
    <section>
      <label>Player
        <input data-bind="
          value: playerName,
          event: {keydown: function () {
            playerVar('');
            return true;
          }}
        ">
        <select data-bind="
          options: variables,
          optionsText: 'name',
          value: playerVar,
          optionsCaption: '-',
          event: {change: function () {
            playerName('');
          }}
          "></select>
      </label>
    </section>
  <!-- /ko -->
  
  <!-- Item Picker ------------------------------------------------------------>
  <!-- ko if: command().id === 'give' -->
    <section>
      <label>Item
        <select data-bind="
          options: items,
          optionsText: 'name',
          value: item
        "></select>
      </label>
    </section>
  <!-- /ko -->
  
  <!-- Amount input ----------------------------------------------------------->
  <!-- ko if: command().id === 'give' -->
    <section>
      <label>Amount
        <input type="number" min="1" max="64" data-bind="value: amount">
      </label>
    </section>
  <!-- /ko -->
  
  <!-- Metadata input --------------------------------------------------------->
  <!-- ko if: command().id === 'give' -->
    <section>
      <label>Metadata
        <input type="number" min="0" max="256" data-bind="value: metadata">
      </label>
    </section>
  <!-- /ko -->
  
  <!-- Tag builder ------------------------------------------------------------>
  <section>
    <label>Tag</label>
    <ul data-bind="template: {name: 'tagTemplate', data: tag}"></ul>
  </section>
  
  <!-- Tag Template ----------------------------------------------------------->
  <script type="text/html" id="tagTemplate">
    <li data-bind="attr:{title: data.description}">
      
      <!-- ko if: parent !== null -->
        <input type="button" value="x" data-bind="click: removeSelf">
      <!-- /ko -->
      
      <!-- ko if: data.id -->
        <label data-bind="text: data.id"></label>
      <!-- /ko -->
      
      <!-- ko if: data.type === 'string' -->
        <input data-bind="value: value">
      <!-- /ko -->
      
      <!-- ko if: data.type === 'value' -->
        <select data-bind="
          options: values,
          optionsText: 'label',
          value: value
        "></select>
      <!-- /ko -->
      
      <!-- ko if: data.type === 'number' -->
        <input type="number" data-bind="value: value">
      <!-- /ko -->
      
      <!-- ko if: data.type === 'boolean' -->
        <label>true <input type="radio" value="true" data-bind="trueOrFalse: value"></label>
        <label>false <input type="radio" value="false" data-bind="trueOrFalse: value"></label>
      <!-- /ko -->
      
      <!-- ko if: data.type === 'list' || data.type === 'compound' -->
        <ul data-bind="template: {name: 'tagTemplate', foreach: children}"></ul>
        
        <select data-bind="
          options: options,
          optionsText: 'id',
          value: selected,
          visible: canAdd()
        "></select>
        
        <input type="button" value="add" data-bind="
          click: addChild,
          visible: canAdd()
        ">
      <!-- /ko -->
      
      
    </li>
  </script>
  
  <!-- Output ----------------------------------------------------------------->
  <section>
    <label>Output
      <textarea style="width: 100%; height: 10em" data-bind="text: output"></textarea>
    </label>
  </section>
  
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.0.0/knockout-min.js"></script>
  <script type="text/javascript">
  
    var app = new App();
    ko.applyBindings(app);
    
    /* View Model *************************************************************/
    function App() {
      var that = this;
      
      // ajax observables
      this.commands = ko.observable({id: "Loading..."});
      this.variables = ko.observable();
      this.entities = ko.observable();
      this.items = ko.observable({id: "Loading..."});
      $.get('commands?sort=id', {}, function success(res) { that.commands(res); });
      $.get('variables?sort=id', {}, function success(res) { that.variables(res); });
      $.get('values?kind__in=entity&sort=id', {}, function success(res) { that.entities(res); });
      $.get('values?kind__in=block,item&sort=id', {}, function success(res) { that.items(res); });
      
      // user input observables
      this.command = ko.observable('');
      this.item = ko.observable({});
      this.tag = ko.computed(function () {
        if (that.command().id === 'give') {
          return new Tag({id:'tag', type:'compound'});
        } else {
          return new Tag({id:'Entity', type:'compound'});
        }
      });
      this.playerVar = ko.observable();
      this.playerName = ko.observable();
      this.player = ko.computed(function() {
        return that.playerVar() ? that.playerVar().id : that.playerName();
      });
      this.amount = ko.observable(0);
      this.metadata = ko.observable(0);
      this.entity = ko.observable('');
      this.x = ko.observable('0');
      this.x.rel = ko.observable(true);
      this.y = ko.observable('0');
      this.y.rel = ko.observable(true);
      this.z = ko.observable('0');
      this.z.rel = ko.observable(true);
      
      /* output the compiled command ******************************************/
      this.output = ko.computed(function compile() {
        var args = [that.command().id];
        
        switch (args[0]) {
            
          case 'give':
            args = args.concat([
              that.player(),
              that.item().id,
              that.amount(),
              that.metadata(),
              that.tag().toString()
            ]);
            break;
            
          case 'summon':
            args = args.concat([
              that.entity().name,
              (that.x.rel() ? '~' : '') + that.x(),
              (that.y.rel() ? '~' : '') + that.y(),
              (that.z.rel() ? '~' : '') + that.z(),
              that.tag().toString()
            ]);
            break;
        }
        return "/" + args.join(" ");
      });
    }
    
    /* Tag class **************************************************************/
    function Tag(data, parent) {
      //console.log("creating new tag");
      var that = this;
      
      this.data = data? data: {id: 'root', type: 'compound'}; // defaults
      this.parent = parent ? parent : null;
      this.options = ko.observableArray();
      $.get('tags' + (this.data.id ? '?parent=' + this.data.id : ''), {}, function success(res) { 
        that.options(res);
      });
      this.selected = ko.observable();
      
      this.values = ko.observable();
      if (this.data.type === 'value') {
        $.get('values?kind__in=' + this.data.kind, {}, function success(res) { 
          that.values(res);
          //console.log(res);
        });
      }
      
      this.value = ko.observable(this.data.type === 'string' ? '' : (this.data.type === 'boolean' ? false : 0)); // not used by lists or compounds
      this.children = ko.observableArray([]); // not used by strings, numbers, or bools
      
      this.canAdd = function () {
        //console.log(this.data.type);
        if (this.data.type === 'list') {
          //console.log(this.children().length);
          return this.data.limit ? this.children().length < this.data.limit : true;
        } 
        else if (this.data.type === 'compound') {
          return this.options().length > 0;
        } 
        else {
          return false;
        }
      };
      
      this.addChild = function (data) {
        //console.log("adding a child");
        var tag = new Tag(data.selected(), this);
        this.children.push(tag);
        
        // remove the tag from the list of options
        if (this.data.type !== 'list') { // lists can have multiples
          this.options.remove(function (item) {
            return item.id == tag.data.id;
          });
        }
        
      };
      
      this.removeSelf = function (data) {
        // removes this tag from it's parent and adds it's option back to the parents menu
        this.parent.options.push(this.parent.children.remove(data)[0].data);
      };
      
      this.toString = ko.computed(function () {
        if (
          that.data.type === 'list' ||
          that.data.type === 'compound'
        ) {
          var out = Array(),
            children = that.children();
            
          for(var i = 0, n = children.length; i < n; i++) {
            // only compounds have identifiers for their children
            out.push((that.data.type === 'compound' ? children[i].data.id + ':' : '') + children[i].toString());
          }
          if (that.data.type === 'list') {
            return "[" + out.join(',') + "]";
          } else {
            return "{" + out.join(',') + "}";
          }
        } 
        else if (that.data.type === 'string') {
          return '"' + that.value() + '"';
        } 
        else if (that.data.type === 'boolean') {
          return that.value() ? 1 : 0;
        }
        else if (that.data.type === 'value') {
          return that.value() ? that.value().id : '';
        }
        else {
          return that.value();
        }
      });
    }
    
    ko.bindingHandlers.trueOrFalse = {
      init: function(element, valueAccessor, allBindingsAccessor) {
        var observable = valueAccessor(),
          interceptor = ko.computed({
            read: function() {
              return observable();  
            },
            write: function(newValue) {
              observable(newValue === "true");
            },
            owner: this   
          });
        ko.applyBindingsToNode(element, { checked: interceptor });     
      }
    };

  </script>
</body>
</html>